generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  name      String?
  email     String?  @unique
  password  String?
  role      Role
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Teacher {
  id            String   @id @default(uuid()) @db.Uuid
  name          String?
  phone         String?  @unique
  cohortId      String?  @db.Uuid
  anganwadi     Anganwadi? @relation(fields: [anganwadiId], references: [id])
  anganwadiId   String? @unique @db.Uuid 

  cohort        Cohort?  @relation(fields: [cohortId], references: [id], onDelete: SetNull) 
  evaluations   Evaluation[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt  
}

model Cohort {
  id                    String   @id @default(uuid()) @db.Uuid
  name                  String?
  region                String?
  teachers              Teacher[]
  regionalCoordinatorId String?  @db.Uuid
  regionalCoordinator   RegionalCoordinator? @relation(fields: [regionalCoordinatorId], references: [id])
  evaluations           Evaluation[]
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Student {
  id            String      @id @default(uuid()) @db.Uuid
  name          String?
  age           Int?        @db.Integer
  cohortId      String?     @db.Uuid
  gender        String?
  status        String?     @default("ACTIVE")
  anganwadiId   String?     @db.Uuid
  anganwadi     Anganwadi?  @relation(fields: [anganwadiId], references: [id], onDelete: SetNull)
  evaluations   Evaluation[]
  responses     StudentResponse[]
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt  
}

model Anganwadi {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique
  location    String?
  district    String?
  state       String?
  students    Student[]
  teacher     Teacher?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt  
}

model Topic {
  id          String       @id @default(uuid()) @db.Uuid
  name        String
  version     Int          @default(1)
  questions   Question[]
  evaluations Evaluation[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Question {
  id         String   @id @default(uuid()) @db.Uuid
  text       String?
  imageUrl   String?
  audioUrl   String?
  topicId    String   @db.Uuid
  topic      Topic    @relation(fields: [topicId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  evaluations Evaluation[]  @relation("EvaluationQuestions")
  responses   StudentResponse[]
}

model Evaluation {
  id          String     @id @default(uuid()) @db.Uuid
  teacherId   String     @db.Uuid
  topicId     String     @db.Uuid
  studentId   String     @db.Uuid
  cohortId    String?    @db.Uuid
  weekNumber  Int
  metadataUrl String
  audioUrl    String
  createdAt   DateTime   @default(now())

  teacher     Teacher    @relation(fields: [teacherId], references: [id])
  student     Student    @relation(fields: [studentId], references: [id])
  topic       Topic      @relation(fields: [topicId], references: [id])
  cohort      Cohort?    @relation(fields: [cohortId], references: [id])
  
  questions   Question[] @relation("EvaluationQuestions")
  studentResponses   StudentResponse[]
}

model StudentResponse {
  id           String   @id @default(uuid()) @db.Uuid
  evaluationId String   @db.Uuid
  questionId   String   @db.Uuid
  studentId    String   @db.Uuid

  startTime    DateTime
  endTime      DateTime
  audioUrl     String

  evaluation   Evaluation @relation(fields: [evaluationId], references: [id])
  question     Question   @relation(fields: [questionId], references: [id])
  student      Student    @relation(fields: [studentId], references: [id])
}


model RegionalCoordinator {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  email     String   @unique
  password  String?
  cohorts   Cohort[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  ADMIN
  REGIONAL_COORDINATOR
  TEACHER
}
